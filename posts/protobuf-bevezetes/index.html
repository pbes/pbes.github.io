<!DOCTYPE html><html lang="en" class="text-zinc-800"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Familjen+Grotesk:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://pbes.github.io/posts/protobuf-bevezetes"><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><!-- Primary Meta Tags --><title>Bevezetés a Protobuf használatába · pbes blog</title><meta name="title" content="Bevezetés a Protobuf használatába · pbes blog"><meta name="description" content="A Protobuf  platformfüggetlen, nyelvfüggetlen, könnyen olvasható és írható bináris formátum."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://pbes.github.io/posts/protobuf-bevezetes"><meta property="og:title" content="Bevezetés a Protobuf használatába · pbes blog"><meta property="og:description" content="A Protobuf  platformfüggetlen, nyelvfüggetlen, könnyen olvasható és írható bináris formátum."><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://pbes.github.io/posts/protobuf-bevezetes"><meta property="twitter:title" content="Bevezetés a Protobuf használatába · pbes blog"><meta property="twitter:description" content="A Protobuf  platformfüggetlen, nyelvfüggetlen, könnyen olvasható és írható bináris formátum."><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/about.CyUawc5m.css">
<link rel="stylesheet" href="/_astro/_slug_.D70-yzNw.css"><script type="module" src="/_astro/hoisted.Bk9VN7UM.js"></script>
<script type="module" src="/_astro/page.BNYwb576.js"></script></head> <body> <div class="flex flex-col h-full mb-8 overflow-y-scroll antialiased"> <header class="sticky z-50 top-0 bg-white/80 backdrop-blur-xl transition-all select-none bg-gradient-to-b from-orange-50"> <div class="flex flex-row gap-8 items-center justify-between max-w-screen-md mx-auto h-24 px-4 sm:px-6"> <a href="/" class="flex flex-row items-center justify-center gap-2"> <img src="/avatar.jpg" alt="author avatar" class="w-10 rounded-full aspect-square"> <span class="text-orange-600 font-title font-black">pbes blog</span> </a> <div class="flex flex-row gap-4"> <a href="/posts" target="_self" class="h-full text-sm hover:text-orange-700"> Bejegyzések </a><a href="/tags" target="_self" class="h-full text-sm hover:text-orange-700"> Címkék </a><a href="/date" target="_self" class="h-full text-sm hover:text-orange-700"> Archívum </a><a href="/about" target="_self" class="h-full text-sm hover:text-orange-700"> Rólam </a><a href="https://github.com/pbes" target="_blank" class="h-full text-sm hover:text-orange-700"> GitHub </a> </div> </div> </header> <div class="flex-auto">  <div class="flex flex-col gap-8 md:w-5/6 px-4 py-12 sm:px-8 mx-auto"> <div class="flex flex-col gap-6 items-center justify-center max-w-screen-sm mx-auto"> <h1 id="header" class="text-5xl text-center font-title font-black">Bevezetés a Protobuf használatába</h1> <div class="flex items-center justify-center gap-2"> <a href="/date/2024" target="_self" class="px-2.5 py-1 rounded-lg text-xs bg-zinc-50"> December 8, 2024 </a> <a href="/tags/java" target="_self" class="px-2.5 py-1 rounded-lg text-xs text-red-600 font-medium bg-red-50/80 capitalize"> java </a><a href="/tags/protobuf" target="_self" class="px-2.5 py-1 rounded-lg text-xs text-red-600 font-medium bg-red-50/80 capitalize"> protobuf </a> </div> <p class="text-lg text-center text-zinc-700 max-w-[480px]">A Protobuf  platformfüggetlen, nyelvfüggetlen, könnyen olvasható és írható bináris formátum.</p> </div> <img src="/images/protobuf-bevezetes/protobuf-bevezetes-cover.png?w=1200&#38;q=80" alt="cover" class="w-full max-w-screen-md mx-auto rounded-lg"> </div> <div class="relative flex flex-col gap-2 max-w-screen-md mx-auto px-4 sm:px-6 text-base text-zinc-700"> <p> Az idei nagy projekt során egy tömegközlekedési vállalat számára készítettünk egy olyan alkalmazást, amely összegyűjti az információkat a különböző szakrendszereikből, összegzi és megjeleníti őket különböző formátumokban. A feladat része volt egy térképes megjelenítés is. A járművek pozíció jelentései rengeteg információt jelentettek és a fogadás után azokat több helyre kellett szétszórni: </p>
<ul class="list-disc ml-6"> 
<li class="mb-1"> aktuális pozíció megjelenítése a térképen </li>
<li class="mb-1"> menetlevél készítő alkalmazás </li>
<li class="mb-1"> riasztások generálása </li>
 </ul>
<p> Az adatmennyiség kezelése mind átvitel, mind tárolás szempontjából kritikus volt. A JSON formátumot használtuk, de a nagy mennyiségű adat miatt hamarosan kacsintgattunk a jóval kompaktabb bináris formátumok felé. </p>
<h2 id="bináris-encoding-vs-szöveges-formátumok" class="text-2xl font-bold my-2"> Bináris encoding vs. Szöveges formátumok </h2>
<p> Az adatok szerializáció az a folyamat, amely során a strukturált adatokat olyan formátumba alakítjuk át, amely megkönnyíti azok tárolását, küldését és későbbi visszaállítását. Ez alapvető szerepet játszik abban, hogy az alkalmazások hogyan kommunikálnak egymással és hogyan tárolják az információkat. </p>
<p> Két féle mód közül választhatunk: a <span data-notion-identity="notion" data-notion-type="box" data-notion-color="blue" data-notion-strokewidth="1.5"> bináris </span> és a <span data-notion-identity="notion" data-notion-type="box" data-notion-color="blue" data-notion-strokewidth="1.5"> szöveges </span> encoding között. A szöveges formátumok, mint a JSON és az XML, sok okból népszerűvé váltak, különösen a webes alkalmazások esetében. Egyszerűek, könnyen használhatók és érthetők az emberek számára, ami megkönnyíti a hibakeresést és a manuális ellenőrzést. A bináris formátumok ezekkel szemben tömörebb reprezentációt biztosítanak az adatoknak, kevesebb bájtot igényelnek, ami kevesebb tárhelyet és sávszélességet jelent. </p>
<p> Másodsorban, a bináris formátumok egyértelműbbek, ha számokkal vagy speciális karakterekkel kell dolgozni. Például a JSON nem tudja megkülönböztetni a decimális és a lebegőpontos számokat, ami pontossági problémákat okozhat. A bináris formátumok pontosan definiált adattípusokat támogatnak, amelyek segítségével pontosan meghatározható, hogy milyen típusú adatokat tárolnak. </p>
<p> A szöveges formátumok továbbá nem támogatják a nyers bináris adatokat. Ha például egy képet vagy egy hangfájlt szeretnénk átvinni, akkor először kódolnunk kell azokat valamilyen szöveges formátumba (pl Base64), ami további overheadet jelent. </p>
<p> Mindezek miatt érdemes megfontolni a bináris formátumok használatát, ha a tárhely és a sávszélesség kritikus tényezők az alkalmazásunkban. </p>
<h2 id="mi-a-protobuf-és-hogyan-működik" class="text-2xl font-bold my-2"> Mi a Protobuf és hogyan működik? </h2>
<p> A Protcol Buffer, röviden Protobuf a Google megoldása a bináris szerializációra. Nyelvfüggetlen, platform független technológia, amelynek célja, hogy az adatokat (pl Java objektumok) struktúrált formába alakítsa kisebb méretet elérve és gyorsabban mint a hagyományos formátumok (pl JSON vagy XML). </p>
<p> <div src="/images/protobuf-bevezetes/protobuf.drawio.png" alt="Protobuf folyamat" class="flex flex-col gap-2 text-center"> <img class="w-full rounded-lg overflow-clip" src="/images/protobuf-bevezetes/protobuf.drawio.png?w=1024&#38;q=70" alt="Protobuf folyamat"> <span class="text-gray-400 font-normal text-sm">Protobuf folyamat</span> </div> </p>
<p> A Protobuf használatához szükségünk van egy ún. <code>.proto</code> fájlra, amely a sémát írja le. Ezek egyszerű szöveges, technológiától független leírók. </p>
<p> Itt egy példa: </p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e;overflow-x:auto" tabindex="0" data-language="proto"><code><span class="line"><span style="color:#D73A49">syntax</span><span style="color:#D73A49"> =</span><span style="color:#032F62"> &quot;proto2&quot;</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">package</span><span style="color:#032F62"> hu.pbes.blog.protobuf</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">message</span><span style="color:#6F42C1"> Pet</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#D73A49">  required</span><span style="color:#D73A49"> string</span><span style="color:#24292E"> name </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  optional</span><span style="color:#D73A49"> int32</span><span style="color:#24292E"> age </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 2</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#D73A49">  repeated</span><span style="color:#D73A49"> string</span><span style="color:#24292E"> skills </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 3</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p> Az első 2 mező a fenti sémában közelező illetve opcionális. Ez nem befolyásolja az átalakításokat, de képes futási idejű ellenőrzést kikényszerteni, így hamarabb elkapni a lehetséges bugokat. A harmadik mező viszont ismétlődő. Ez azt jelenti, hogy a mező többször is előfordulhat és így használható listák és tömbök implementálására. </p>
<p> Miután elkészültünk a sémával, a <code>protoc</code> compilerrel generálhatjuk a kódot az általunk használt programozási nyelvre. Az alábbi példában a <code>--java_out</code> opció azt jelenti, hogy a generált kód Java nyelvű lesz. </p>
<div class="p-4 border rounded-lg border-zinc-100 text-sm"> 
<p> A 3-as verzióban a required és optional kulcsszavakat eltávolították, mivel a kötelező mezők használata nem támogatja a visszafelé kompatibilitást. </p>
 </div>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1">protoc</span><span style="color:#005CC5"> -I=</span><span style="color:#24292E">$SRC_DIR</span><span style="color:#005CC5"> --java_out=</span><span style="color:#24292E">$DST_DIR</span><span style="color:#24292E"> $SRC_DIR</span><span style="color:#032F62">/pet.proto</span></span>
<span class="line"></span></code></pre>
<p> A generált kód egy könnyen kezelhető interfészt ad, mely tartalmazza a szerializációhoz és a deszerializációhoz szükséges metódusokat. </p>
<p> Amikor szerializáljuk az objektumot, az alkalmazásban kezelt objektumot alakítjuk bináris adattá, mely tárolható vagy továbbítható. </p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> hu.pbes.blog.protobuf.PetOuterClass;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">final</span><span style="color:#D73A49"> var</span><span style="color:#24292E"> pet </span><span style="color:#D73A49">=</span><span style="color:#24292E"> PetOuterClass.Pet.</span><span style="color:#6F42C1">newBuilder</span><span style="color:#24292E">()</span></span>
<span class="line"><span style="color:#24292E">                .</span><span style="color:#6F42C1">setName</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;Fido&quot;</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">                .</span><span style="color:#6F42C1">setAge</span><span style="color:#24292E">(</span><span style="color:#005CC5">3</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">                .</span><span style="color:#6F42C1">addAllSkills</span><span style="color:#24292E">(List.</span><span style="color:#6F42C1">of</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;sit&quot;</span><span style="color:#24292E">, </span><span style="color:#032F62">&quot;stay&quot;</span><span style="color:#24292E">, </span><span style="color:#032F62">&quot;fetch&quot;</span><span style="color:#24292E">))</span></span>
<span class="line"><span style="color:#24292E">                .</span><span style="color:#6F42C1">build</span><span style="color:#24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">try</span><span style="color:#24292E"> (FileOutputStream outputFile </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> FileOutputStream</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;pet.bin&quot;</span><span style="color:#24292E">)) {</span></span>
<span class="line"><span style="color:#24292E">    pet.</span><span style="color:#6F42C1">writeTo</span><span style="color:#24292E">(outputFile);</span></span>
<span class="line"><span style="color:#24292E">} </span><span style="color:#D73A49">catch</span><span style="color:#24292E"> (IOException </span><span style="color:#E36209">e</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    System.err.</span><span style="color:#6F42C1">println</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;Failed to write to file: &quot;</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> e.</span><span style="color:#6F42C1">getMessage</span><span style="color:#24292E">());</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p> Deszerializáció során a használt metódusokkal alakítjuk vissza a bináris formátumot az alkalmazásban kezelhető objektummá. </p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> hu.pbes.blog.protobuf.PetOuterClass;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">try</span><span style="color:#24292E"> (FileInputStream inputFile </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> FileInputStream</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;pet.bin&quot;</span><span style="color:#24292E">)) {</span></span>
<span class="line"><span style="color:#D73A49">    final</span><span style="color:#D73A49"> var</span><span style="color:#24292E"> readPet </span><span style="color:#D73A49">=</span><span style="color:#24292E"> PetOuterClass.Pet.</span><span style="color:#6F42C1">parseFrom</span><span style="color:#24292E">(inputFile);</span></span>
<span class="line"><span style="color:#24292E">    System.out.</span><span style="color:#6F42C1">println</span><span style="color:#24292E">(readPet);</span></span>
<span class="line"><span style="color:#24292E">} </span><span style="color:#D73A49">catch</span><span style="color:#24292E"> (IOException </span><span style="color:#E36209">e</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">    System.err.</span><span style="color:#6F42C1">println</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;Failed to read from file: &quot;</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> e.</span><span style="color:#6F42C1">getMessage</span><span style="color:#24292E">());</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span></code></pre>
<p> A fenti példában szereplő objektum JSON reprezentációja minifikálva <span data-notion-identity="notion" data-notion-type="underline" data-notion-color="red" data-notion-strokewidth="1.5"> 60 byte </span>, míg a Protobuf bináris reprezentációja csak <span data-notion-identity="notion" data-notion-type="underline" data-notion-color="red" data-notion-strokewidth="1.5"> 26 byte </span>. </p>
<h2 id="visszafelé-és-előrefelé-kompatibilitás" class="text-2xl font-bold my-2"> Visszafelé és előrefelé kompatibilitás </h2>
<p> A Protobuf hatalmas előnye, hogy képes kezelni a sémák változását, megtartva a visszafelé kompatibilitást. Ez azt jelenti, hogy az új kód által generált üzeneteket a régi is képes olvasni, és a régi által generált üzeneteket az új kód is képes olvasni, még akkor is, ha a <code>.proto</code> fájlok megváltoztak. </p>
<p> Ennek elérése érdekében a <code>.proto</code> fájlokban található mezőkhoz rendelt <code>tag</code> számokat kell figyelmesen használni, valamint az opcionális mezőket. Nézzünk erre példákat, hogy jobban megértsük: </p>
<ul class="list-disc ml-6"> 
<li class="mb-1"> új mezők hozzáadása egyszerű: felvesszük a proto fájl végére, a régi kód pedig ignorálja </li>
<li class="mb-1"> az új kód képes olvasni a régi adatokat, mindaddig, amíg az új mezők nem kötelezőként megjelöltek </li>
 </ul>
<div class="p-4 border rounded-lg border-zinc-100 text-sm"> 
<p> A fenti kompatibilitás az oka, hogy a 3-as verzióból kikerült a <code>required</code> kulcsszó. </p>
 </div>
<p> A mezők típusának megváltoztatás problémát okozhat, mert egyes módosítások engedélyezettek, mások pedig nem. Például int32-ről int64-re váltás probléma mentes, a parser feltöltheti a hiányzó biteket 0-val, de visszafelé információt vesztenénk. </p>
<h2 id="automatikus-generálás" class="text-2xl font-bold my-2"> Automatikus generálás </h2>
<p> Lehetőségünk van a <code>.proto</code> fájlokból a Maven compile fázisában automatikusan generálni a kódot. Ehhez a <code>protobuf-maven-plugin</code>-t kell használnunk: </p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e;overflow-x:auto" tabindex="0" data-language="xml"><code><span class="line"><span style="color:#24292E">&lt;</span><span style="color:#22863A">plugin</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">groupId</span><span style="color:#24292E">&gt;org.xolstice.maven.plugins&lt;/</span><span style="color:#22863A">groupId</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">artifactId</span><span style="color:#24292E">&gt;protobuf-maven-plugin&lt;/</span><span style="color:#22863A">artifactId</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">version</span><span style="color:#24292E">&gt;0.6.1&lt;/</span><span style="color:#22863A">version</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">extensions</span><span style="color:#24292E">&gt;true&lt;/</span><span style="color:#22863A">extensions</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">executions</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">        &lt;</span><span style="color:#22863A">execution</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">            &lt;</span><span style="color:#22863A">goals</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">                &lt;</span><span style="color:#22863A">goal</span><span style="color:#24292E">&gt;compile&lt;/</span><span style="color:#22863A">goal</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">                &lt;</span><span style="color:#22863A">goal</span><span style="color:#24292E">&gt;test-compile&lt;/</span><span style="color:#22863A">goal</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">            &lt;/</span><span style="color:#22863A">goals</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">        &lt;/</span><span style="color:#22863A">execution</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;/</span><span style="color:#22863A">executions</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;</span><span style="color:#22863A">configuration</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">        &lt;</span><span style="color:#22863A">additionalProtoPathElements</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">            &lt;</span><span style="color:#22863A">additionalProtoPathElement</span><span style="color:#24292E">&gt;${project.basedir}/src/main/resources&lt;/</span><span style="color:#22863A">additionalProtoPathElement</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">        &lt;/</span><span style="color:#22863A">additionalProtoPathElements</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">    &lt;/</span><span style="color:#22863A">configuration</span><span style="color:#24292E">&gt;</span></span>
<span class="line"><span style="color:#24292E">&lt;/</span><span style="color:#22863A">plugin</span><span style="color:#24292E">&gt;</span></span>
<span class="line"></span></code></pre>
<p> Az alkalmazás példakódja elérhető a GitHub-on: <a href="https://github.com/pbes/protobuf-example" href="https://github.com/pbes/protobuf-example" class="text-blue-600 after:content-['_↗']" target="_blank" rel="noopener noreferrer"> https://github.com/pbes/protobuf-example </a> </p> </div>  </div> <footer class="bg-gradient-to-t from-orange-50"> <div class="flex flex-row items-center justify-center max-w-screen-md h-96 mx-auto px-4 sm:px-6"> <p class="text-4xl leading-[60px] bg-clip-text text-center text-transparent bg-gradient-to-r from-orange-600 to-amber-600 font-title font-black"> Beszéljünk a technológiáról 🚀 </p> </div> </footer> </div> </body></html> 